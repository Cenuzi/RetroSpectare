<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RetroSpectare PMV</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" />
	<link rel="preload" as="image" href="MGS/logo.png">
	<link rel="preload" as="font" href="https://fonts.googleapis.com/css2?family=Noto+Sans+Symbols&display=swap" crossorigin="anonymous">
	<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+Symbols&display=swap');
        
        body { 
            text-align: center; 
            font-family: 'Arial', 'Noto Sans Symbols', sans-serif; 
            background: url("MGS/CNI.jpg") no-repeat center center fixed;
			background-size: cover;
            color: #333; 
            margin: 0; 
            padding: 0;
            overflow-x: hidden;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .content {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: 20px;
        }

		/* Contenedor de la pantalla de inicio */
		.splash-screen {
			position: fixed;
			width: 100%;
			height: 100%;
			display: flex;
			justify-content: center;
			align-items: center;
			text-align: center;
			z-index: 1000;
			flex-direction: column;
			transition: opacity 1s ease-out;
			background-color: black; /* Fondo negro para logo de RetroSpectare */
			
		}
		
		/* Primera fase con fondo negro */
		#phase1 {
			background-color: black; /* Fondo negro solo para el logo de RetroSpectare */
			width: 100%;
			height: 100%;
			position: absolute;
			display: flex;
			justify-content: center;
			align-items: center;
		}

		/* Segunda fase con fondo blanco */
		#phase2 {
			background-color: white; /* Fondo blanco para los logos de patrocinadores */
			width: 100%;
			height: 100%;
			position: absolute;
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}

		/* Contenedor de cada fase (logo de RetroSpectare y logos de patrocinadores) */
		.splash-phase {
			display: flex;
			flex-direction: column;
			align-items: center;
			justify-content: center;
			width: 100%;
			position: absolute;
			transition: opacity 1s ease-in-out;
		}

		/* Logo de RetroSpectare */
		.splash-logo {
			max-width: 45vw;
			max-height: 45vh;
			height: auto;
		}

		/* Logos de patrocinadores */
		.splash-logos {
			max-width: 40vw;
			max-height: 40vh;
			height: auto;
			margin-top: 20px;
		}

		/* Texto "Con el apoyo de:" */
		.splash-title {
			font-size: 1.5em;
			font-weight: bold;
			color: #333;
			margin-bottom: 10px;
		}

		/* Ocultar elementos con transición suave */
		.hidden {
			opacity: 0;
			pointer-events: none;
		}
		
		.banner {
			background: linear-gradient(90deg, #4CAF50, #2196F3);
			color: white;
			padding: 20px;
			text-align: center;
		}

		.banner .title {
			font-size: 24px;
			font-weight: bold;
			text-transform: uppercase;
			letter-spacing: 2px;
		}

		.banner .claim {
			font-size: 16px;
			font-weight: normal;
			text-transform: none;
			font-style: italic;
			margin-top: 5px;
		}

        .container { 
            position: relative; 
            width: 300px; 
            height: 360px; 
            background: white;
            border-radius: 10px; 
            border: 10px solid white;
            box-shadow: 0px 4px 10px rgba(0, 0, 0, 0.2);
            padding: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin-top: 20px;
        }
        .controls-container {
            width: 300px;
            margin-top: 15px;
            margin-bottom: 40px;
			background: rgba(255, 255, 255, 0.85);
			border-radius: 12px;
			padding: 15px;
        }
		
		.controls-container label {
			color: #000;
			font-weight: bold;
			text-shadow: 1px 1px 2px rgba(255,255,255,0.6);
		}
		
		video {
			width: 95%;  /* Ajusta el ancho dejando un pequeño margen */
			height: 95%; /* Ajusta la altura con margen */
			object-fit: cover; /* Asegura que el video cubra el área correctamente */
			border-radius: 10px; /* Bordes redondeados opcionales */
			border: 5px solid white; /* Borde blanco opcional */
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			z-index: 1;
		}

		#overlay {
			width: 90%;
			max-width: 100%;  /* Mantiene la imagen ocupando todo el ancho */
			height: 90%;
			max-height: 100%;  /* Permite que mantenga su proporción */
			object-fit: contain; /* Evita cortes en la imagen */
			opacity: 0.5; /* Mantiene la opacidad controlada */
			transition: left 0.5s ease-in-out, opacity 0.5s ease-in-out;
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			z-index: 2;
			pointer-events: none;
		}
	
        .controls { 
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
		
		.map-toggle {
			position: absolute;
			right: -70px; /* Mueve los botones fuera del borde derecho */
			width: 45px;
			height: 50px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 10px;
			cursor: pointer;
			font-size: 24px;
			color: #2196F3;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			display: flex;
			flex-direction: column;
			justify-content: center;
			align-items: center;
		}		
				
		/* Cambia el color al pasar el cursor */
		.map-toggle:hover {
			background: #2196F3;
			color: white;
			border-color: white;
		}
		
		/* Posicionamiento individual para los botones */
		#mapButton {
			top: 20px; /* Ubica el primer botón */
			position: absolute;
			right: -70px; /* Mantiene la posición fuera del borde derecho */
			width: 45px;
			height: 50px; /* Mantener el botón alargado */
			background: white;
			border: 2px solid #2196F3;
			border-radius: 10px;
			cursor: pointer;
			color: #2196F3;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
			
			/* Corrección de alineación específica para este botón */
			display: flex;
			justify-content: center; /* Centra el ícono verticalmente */
			align-items: center; /* Centra el ícono horizontalmente */
			flex-direction: row; /* Mantiene una estructura horizontal */
		}
		
		#mapButton:hover {
			background: #2196F3 !important;
			color: white !important;
			border-color: white !important;
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
		}

		#mapButton i {
			font-size: 24px; /* Ajusta el tamaño del icono */
			line-height: 1; /* Evita que el icono se desplace verticalmente */
			height: auto; /* Se adapta dinámicamente */
		}


		#openMuseumMap {
			top: 80px; /* Ubica el segundo botón debajo del primero */
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
		}	
		
		.footer {
			background-color: #333;
			color: white;
			padding: 20px;
			font-size: 14px;
			display: flex;
			align-items: center;
			justify-content: space-between; /* 👈 Distribuye los logos en los extremos */
			flex-wrap: wrap;
			position: relative;
		}

		.footer-left-logo,
		.footer-right-logo {
			height: 55px;
			width: auto;
		}

		.footer-text {
			text-align: center;
			flex: 1;
			padding: 0 20px; /* 👈 Da espacio entre los logos */
		}

		.footer-quote {
			font-style: italic;
			opacity: 0.7;
			font-size: 13px;
			margin-top: 8px;
			text-align: center;
			width: 100%;
		}

		.footer-links {
			margin-top: 10px;
			display: flex;
			gap: 15px;
			justify-content: center;
			font-size: 13px;
		}

		.footer-links a {
			color: white;
			text-decoration: none;
			opacity: 0.8;
		}

		.footer-links a:hover {
			color: #4CAF50;
		}
		
        .map-container {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100vh;
            background: white;
            box-shadow: -2px 0 5px rgba(0,0,0,0.3);
            transition: right 0.3s ease-in-out;
            z-index: 999;
        }
        #map {
            width: 100%;
            height: 100%;
        }
		.close-map-button {
			position: absolute;
			top: 10px;
			right: 10px;
			background: red;
			color: white;
			border: none;
			font-size: 24px;
			font-weight: bold;
			padding: 5px 10px;
			cursor: pointer;
			border-radius: 5px;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			z-index: 1001; /* Asegura que está sobre otros elementos */
		}
		.close-map-button:hover {
			background: darkred;
		}
		
		#museumMapContainer {
			position: fixed;
			top: 0;
			left: -350px; /* Inicialmente oculto fuera de la pantalla */
			width: 350px; /* Tamaño del panel lateral */
			height: 100vh; /* Ocupa toda la altura */
			background: white;
			box-shadow: 2px 0 5px rgba(0, 0, 0, 0.3); /* Sombra a la derecha */
			transition: left 0.3s ease-in-out; /* Animación suave */
			z-index: 999;
			display: block; /* Cambiar de 'none' a 'block' */
		}

		/* Cuando el mapa del museo esté visible */
		#museumMapContainer.active {
			left: 0; /* Mueve el panel a la vista */
		}
		
		#museumMap {
			width: 100%;
			height: 100%;
			min-height: 300px; /* Asegura que tenga una altura mínima */
		}
		
		#closeMuseumMap {
			position: absolute;
			top: 10px;
			right: 10px;
			background: red;
			color: white;
			border: none;
			font-size: 24px;
			font-weight: bold;
			padding: 5px 10px;
			cursor: pointer;
			border-radius: 5px;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			z-index: 1001;
		}

		#closeMuseumMap:hover {
			background: darkred;
		}
		
		.popup {
			display: none;
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background: rgba(0, 0, 0, 0.5);
			justify-content: center;
			align-items: center;
			z-index: 1000;
		}

		.popup-content {
			background: white;
			padding: 20px;
			border-radius: 10px;
			text-align: center;
			width: 300px;
			box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
			position: relative;
		}

		.popup-content img {
			max-width: 100%;
			border-radius: 8px;
		}

		.close-popup {
			position: absolute;
			top: 10px;
			right: 10px;
			background: red;
			color: white;
			border: none;
			font-size: 18px;
			padding: 5px;
			cursor: pointer;
			border-radius: 5px;
		}
		
		.info-button {
			position: absolute;
			top: 10px;
			right: 10px;
			background: transparent;
			color: white;
			border: none;
			border-radius: 50%;
			padding: 5px 10px;
			cursor: pointer;
			font-size: 24px;
			z-index: 3;
		}
		
		#openInfoButton {
			top: 200px; /* Ubicarlo debajo del botón del mapa del museo */
			position: absolute;
			right: -70px; /* Mantiene la posición fuera del borde derecho */
			width: 45px;
			height: 50px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 10px;
			cursor: pointer;
			color: #2196F3;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
		}

		#openInfoButton:hover {
			background: #2196F3;
			color: white;
			border-color: white;
		}
		
		.settings-toggle {
			position: absolute;
			left: -70px; /* Mueve el botón fuera del contenedor */
			top: 90%;
			transform: translateY(-50%);
			width: 50px;
			height: 50px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 50%;
			cursor: pointer;
			font-size: 24px;
			color: #2196F3;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
		}

		.settings-toggle:hover {
			background: #2196F3;
			color: white;
			border-color: white;
		}
		
		#resetOverlay {
			position: absolute;
			left: -70px; /* Alineado a la izquierda como el botón de configuración */
			top: 75%; /* Ajusta la posición encima del botón de configuración */
			transform: translateY(-50%);
			width: 50px;
			height: 50px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 50%; /* Hace que el botón sea circular */
			cursor: pointer;
			font-size: 24px;
			color: #2196F3;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
		}

		#resetOverlay:hover {
			background: #2196F3;
			color: white;
			border-color: white;
		}
		
		#captureButton {
			position: absolute;
			right: -70px; /* Mantiene la alineación con los otros botones flotantes */
			top: 260px; /* Ubicarlo debajo del botón de fichas de información */
			width: 45px;
			height: 50px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 10px;
			cursor: pointer;
			font-size: 24px;
			color: #2196F3;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
		}

		#captureButton:hover {
			background: #2196F3;
			color: white;
			border-color: white;
		}
		
		#toggleCamera {
			position: absolute;
			left: -70px; /* Mismo alineamiento que el botón de reset */
			top: 60%; /* Ajusta la altura para colocarlo encima del botón de reset */
			transform: translateY(-50%);
			width: 50px;
			height: 50px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 50%; /* Hace que el botón sea circular */
			cursor: pointer;
			font-size: 24px;
			color: #2196F3;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
		}

		#toggleCamera:hover {
			background: #2196F3;
			color: white;
			border-color: white;
		}
		
		.routes-toggle {
			position: absolute;
			right: -70px; /* Ubicación junto a otros botones flotantes */
			top: 140px; /* Ajusta la posición debajo de otros botones */
			width: 45px;
			height: 50px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 10px;
			cursor: pointer;
			font-size: 24px;
			color: #2196F3;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			display: flex;
			justify-content: center;
			align-items: center;
			transition: background 0.3s ease-in-out, color 0.3s ease-in-out;
		}

		.routes-toggle:hover {
			background: #2196F3;
			color: white;
			border-color: white;
		}
		
		.routes-menu {
			position: fixed;
			right: -390px;
			top: 0;
			width: 350px;
			height: 100vh;
			background: white;
			box-shadow: -2px 0 5px rgba(0, 0, 0, 0.3);
			transition: right 0.3s ease-in-out;
			padding: 20px;
			overflow-y: auto;
			z-index: 999;
		}

		.close-menu-button {
			position: absolute;
			top: 10px;
			right: 10px;
			background: red;
			color: white;
			border: none;
			font-size: 24px;
			font-weight: bold;
			padding: 5px 10px;
			cursor: pointer;
			border-radius: 5px;
		}

		.close-menu-button:hover {
			background: darkred;
		}
		
		.route-item {
			display: flex;
			align-items: center;
			gap: 10px;
			border-bottom: 1px solid #ddd;
			padding: 10px 0;
		}

		.route-thumbnail {
			width: 60px;
			height: 60px;
			border-radius: 5px;
		}

		.start-route-button {
			background: #2196F3;
			color: white;
			border: none;
			padding: 5px 10px;
			cursor: pointer;
			border-radius: 5px;
			font-size: 14px;
		}

		.start-route-button:hover {
			background: #1976D2;
		}
		
		.next-image-button {
			margin-top: 10px;
			padding: 8px 12px;
			background: #2196F3;
			color: white;
			border: none;
			border-radius: 5px;
			font-size: 16px;
			cursor: pointer;
			display: block;
			width: 100%;
			max-width: 200px;
			margin-left: auto;
			margin-right: auto;
		}

		.next-image-button:hover {
			background: #1976D2;
		}
		
		#overlayPlaceholder {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			color: #888;
			text-align: center;
			font-size: 16px;
			z-index: 2;
			pointer-events: none;
			opacity: 0.6;
		}

		#overlayPlaceholder i {
			font-size: 40px;
			margin-bottom: 10px;
		}
		
		@media (max-width: 600px) {
		
		  body {
			background-attachment: scroll !important;
			background-position: center top !important;
		  }
		
		  .container {
			width: 90vw;
			height: auto;
			aspect-ratio: 3 / 4;
			padding: 10px;
			box-sizing: border-box;
		  }

		  .controls-container {
			width: 90vw;
			padding: 12px;
			box-sizing: border-box;
		  }

		  video,
		  #overlay {
			width: 100%;
			height: 100%;
		  }

		  .banner .title {
			font-size: 18px;
		  }

		  .banner .claim {
			font-size: 14px;
		  }

		  .footer-text {
			font-size: 12px;
		  }

		  /* Reposicionar botones flotantes en pantalla visible */
		  .map-toggle,
		  .settings-toggle,
		  .routes-toggle {
			position: fixed !important;
			right: 10px !important;
			left: auto !important;
			top: unset !important;
			width: 45px;
			height: 45px;
			z-index: 1002;
		  }

		  #mapButton { bottom: 60px; }
		  #openMuseumMap { bottom: 120px; }
		  #openInfoButton { bottom: 180px; }
		  #captureButton { bottom: 240px; }
		  #routesButton { bottom: 300px; }
		  #openProfileButton { bottom: 360px; }

		  #settingsButton {
			bottom: 420px;
			left: 10px !important;
			right: auto !important;
		  }

		  #resetOverlay {
			bottom: 480px;
			left: 10px !important;
			right: auto !important;
		  }

		  #toggleCamera {
			bottom: 540px;
			left: 10px !important;
			right: auto !important;
		  }
		  
		#fullscreenButton {
			position: fixed;
			left: 10px;
			bottom: 600px; /* justo encima del botón de cámara */
			width: 45px;
			height: 45px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 50%;
			font-size: 20px;
			color: #2196F3;
			display: flex;
			justify-content: center;
			align-items: center;
			z-index: 3000;
			box-shadow: 0 2px 6px rgba(0,0,0,0.3);
		  }
		  
		  body.fullscreen-active .container {
			  width: 100vw !important;
			  height: 100vh !important;
			  max-width: 100vw;
			  max-height: 100vh;
			  margin: 0;
			  padding: 0;
			  border: none;
			  box-shadow: none;
			  border-radius: 0;
			}
		  
		  #fullscreenButton:hover {
			background: #2196F3;
			color: white;
		  }	  
		}
		
		@media (min-width: 601px) {
		  #fullscreenButton {
			position: absolute;
			left: -70px;
			top: 45%;
			transform: translateY(-50%);
			width: 50px;
			height: 50px;
			background: white;
			border: 2px solid #2196F3;
			border-radius: 50%;
			font-size: 24px;
			color: #2196F3;
			display: flex;
			justify-content: center;
			align-items: center;
			cursor: pointer;
			box-shadow: 0px 4px 6px rgba(0, 0, 0, 0.2);
			transition: all 0.3s ease-in-out;
			z-index: 1001;
		  }
		  
		/* Estilo cuando estamos en pantalla completa */
		body.fullscreen-active #fullscreenButton {
		  position: fixed;
		  left: auto;
		  right: 15px;
		  bottom: 15px;
		  top: auto;
		  transform: none;
		  z-index: 3000;
		}

		#fullscreenButton:hover {
		  background: #2196F3;
		  color: white;
		}
		
		.intro-active #mapButton,
		.intro-active #openMuseumMap,
		.intro-active #openInfoButton,
		.intro-active #captureButton,
		.intro-active #routesButton,
		.intro-active #openProfileButton,
		.intro-active #settingsButton,
		.intro-active #resetOverlay,
		.intro-active #toggleCamera,
		.intro-active #fullscreenButton {
			display: none !important;
		}

    </style>
</head>
<body class="intro-active">
    
	<div class="splash-screen" id="splash">
		<!-- Primera fase: Logo de RetroSpectare -->
		<div class="splash-phase" id="phase1">
			<img src="MGS/logo.png" alt="RetroSpectare Logo" class="splash-logo">
		</div>

		<!-- Segunda fase: Logos de patrocinadores -->
		<div class="splash-phase hidden" id="phase2">
			<h2 class="splash-title">Con el apoyo de:</h2>
			<img src="MGS/logos.png" alt="Patrocinadores" class="splash-logos">
		</div>
	</div>

	<div class="banner">
		<div class="title">RetroSpectare</div>
		<div class="claim">Una mirada al pasado</div>
	</div>
	
    <div class="content">
        <div class="container">
            <video id="camera" autoplay></video>
            <img id="overlay" src="" alt="">
			
			<div id="overlayPlaceholder">
				<i class="fas fa-image"></i>
				<p>Sin imagen seleccionada</p>
			</div>
			
			<!-- Botón del mapa exterior -->
            <button class="map-toggle" id="mapButton" onclick="toggleMap()" title="Mostrar/Ocultar el mapa exterior">
                <i class="fas fa-map-marker-alt"></i>
            </button>
			
			<!-- Botón del mapa del museo -->
			<button class="map-toggle" id="openMuseumMap" title="Mostrar/Ocultar el mapa del museo">
				<i class="fas fa-map"></i>
			</button>
			
			<!-- Botón para abrir la ficha de información -->
			<button class="map-toggle" id="openInfoButton" title="Ver información histórica de la imagen" style="top: 260px;">
				<i class="fas fa-info-circle"></i>
			</button>
			
			<!-- Botón de configuración -->
			<button id="settingsButton" class="settings-toggle" title="Activar/Desactivar cámara y ubicación">
				<i class="fas fa-cog"></i>
			</button>
			
			<!-- Contenedor del mapa del museo -->
			<div id="museumMapContainer" class="map-container">
				<button id="closeMuseumMap" class="close-map-button">&times;</button>
				<div id="museumMap"></div>
			</div>
			
			<!-- Botón de reset -->
			<button id="resetOverlay" class="settings-toggle" title="Quitar imagen superpuesta y reiniciar opacidad">
				<i class="fas fa-undo"></i>
			</button>
			
			<!-- Botón de capturar comparación -->
			<button id="captureButton" class="map-toggle" title="Capturar imagen actual con superposición" style="top: 320px">
				<i class="fas fa-camera"></i>
			</button>
			
			<!-- Botón para alternar entre cámaras -->
			<button id="toggleCamera" class="settings-toggle" title="Cambiar entre cámara frontal y trasera">
				<i class="fas fa-sync-alt"></i>
			</button>
			
			<!-- Botón de rutas -->
			<button id="routesButton" class="routes-toggle" title="Explorar rutas disponibles">
				<i class="fas fa-route"></i>
			</button>
			
			<!-- Botón para abrir la ficha de usuario -->
			<button id="openProfileButton" class="map-toggle" title="Ver mi progreso" style="top: 200px;">
				<i class="fas fa-user"></i>
			</button>
			
			<!-- Botón para pantalla completa -->
			<button id="fullscreenButton" style="display: none;" class="fullscreen-toggle" title="Pantalla completa">
				<i class="fas fa-expand"></i>
			</button>

        </div>
		
        <div class="controls-container">
            <div class="controls">
                <label for="imageSelect">📷 Selecciona una imagen:</label>
                <select id="imageSelect"></select>
				<button id="nextRouteImageButton" class="next-image-button">➡️ Siguiente imagen</button>
                <div class="control-group">
                    <label for="opacity">🔆 Ajustar Opacidad:</label>
                    <input type="range" id="opacity" min="0" max="1" step="0.01" value="0.5">
                </div>
            </div>
        </div>
    </div>
	
	<div id="imagePopup" class="popup">
		<div class="popup-content">
			<button class="close-popup" onclick="closePopup()">❌</button>
			<h2 id="popupTitle">Información de la Imagen</h2>
			<img id="popupImage" src="" alt="Imagen relacionada">
			<p id="popupDescription">Aquí aparecerá la descripción de la imagen.</p>
		</div>
	</div>

	<div class="map-container" id="mapContainer">
		<button id="closeMap" class="close-map-button" style="position:absolute; top:10px; right:10px;">&times;</button>
		<div id="map"></div>
	</div>
	
	<div id="routesMenu" class="routes-menu">
		<button id="closeRoutesMenu" class="close-menu-button">&times;</button>
			<h2>📍 Rutas Disponibles</h2>
		<div id="routesList"></div>
	</div>

	<div class="footer">
	
		<img class="footer-left-logo" src="MGS/MC.png" alt="Logo de El Museo Canario">
		
		<div class="footer-text">
			© <span id="year"></span> RetroSpectare
			<div class="footer-quote">Una mirada al pasado</div>
			<div class="footer-links">
				<a href="#">Créditos</a>
				<a href="#">Contacto</a>
			</div>
		</div>

		<img class="footer-right-logo" src="MGS/GDC.svg.png" alt="Logo del Gobierno de Canarias">
		
	</div>
	
	<!-- Ficha de usuario -->
	
	<div id="userProfile" class="routes-menu" style="right: -390px;">
		<button id="closeProfileButton" class="close-menu-button">&times;</button>
		<h2>👤 Mi progreso</h2>
		<p><strong>Lugares visitados:</strong> <span id="profileVisitCount">0</span></p>
		
		<p><strong>Nivel:</strong> <span id="userLevel">1</span></p>
		<div style="background:#ddd; border-radius:10px; overflow:hidden; height:20px;">
			<div id="xpBar" style="height:100%; width:0%; background:#4CAF50;"></div>
		</div>
		<p><small><span id="currentXP">0</span> / <span id="xpToNext">100</span> XP</small></p>

		<h3>🏅 Insignias</h3>
		<div id="badgeContainer" style="display:flex; flex-wrap:wrap; gap:10px;"></div>
	</div>

    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script>
	
		window.addEventListener("load", function() {
			setTimeout(() => {
				// Oculta la primera fase (logo de RetroSpectare)
				document.getElementById("phase1").classList.add("hidden");

				setTimeout(() => {
					// Muestra la segunda fase (logos de patrocinadores)
					document.getElementById("phase2").classList.remove("hidden");

					setTimeout(() => {
						// Oculta toda la pantalla de inicio
						document.getElementById("splash").classList.add("hidden");
						document.body.classList.remove("intro-active");
						document.getElementById("fullscreenButton").style.display = "flex";
					}, 3000); // Tiempo que los logos de patrocinadores estarán visibles

				}, 500); // Pequeña pausa entre fases

			}, 2000); // Tiempo del logo de RetroSpectare en pantalla
		});
		
		window.addEventListener("load", function() {
			// **Acceso a la cámara**
			navigator.mediaDevices.getUserMedia({ video: true })
				.then(stream => {
					document.getElementById('camera').srcObject = stream;
				})
				.catch(err => console.error("Error al acceder a la cámara:", err));
		});

		window.addEventListener("load", function() {
			// **Evento para cerrar el mapa**
			document.getElementById("closeMap").addEventListener("click", toggleMap);
		});
		
		const imageSelect = document.getElementById("imageSelect");
        const overlay = document.getElementById("overlay");
		const opacityControl = document.getElementById("opacity");
		
        const images = [
			"MGS/C01.jpg", "MGS/C02.jpg", "MGS/C03.jpg",
			"MGS/C04.jpg", "MGS/C05.jpg", "MGS/C06.jpg",
			"MGS/C07.jpg", "MGS/C08.jpg", "MGS/C09.jpg",
			"MGS/C10.jpg", "MGS/C11.jpg", "MGS/C12.jpg",
			"MGS/C13.jpg", "MGS/C14.jpg", "MGS/C15.jpg",
			"MGS/M01.jpg", "MGS/M02.jpg", "MGS/M03.jpg",
			"MGS/M04.jpg", "MGS/M05.jpg", "MGS/M06.jpg",
			"MGS/M07.jpg", "MGS/M10.jpg", "MGS/M11.jpg",
			"MGS/M12.jpg", "MGS/M14.jpg"
        ];
		
		imageSelect.innerHTML = `<option value="" selected disabled>Selecciona una imagen</option>` + 
			images.map(src => `<option value="${src}">${src.split("/").pop()}</option>`).join('');

		imageSelect.addEventListener("change", event => {
			if (event.target.value) {
				overlay.style.opacity = "0"; // Ocultar imagen actual
				overlay.style.left = "60%"; // Mueve la imagen ligeramente a la derecha

				setTimeout(() => {
					updateOverlay(event.target.value);
					overlay.style.left = "50%"; // Vuelve a la posición original centrada
					overlay.style.opacity = "0.5";
				}, 500);
			}
		});
		
		opacityControl.addEventListener("input", event => {
        overlay.style.opacity = event.target.value;
        });
        
        const mapContainer = document.getElementById('mapContainer');
        function toggleMap() {
            mapContainer.style.right = mapContainer.style.right === '0px' ? '-350px' : '0px';
        }
        
        const map = L.map('map').setView([28.1014, -15.4165], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);
		
		const imageLocations = {
			"MGS/C01.jpg": { lat: 28.108809, lng: -15.417086 },
			"MGS/C02.jpg": { lat: 28.108264, lng: -15.417456 },
			"MGS/C03.jpg": { lat: 28.105750, lng: -15.416119 },
			"MGS/C04.jpg": { lat: 28.104806, lng: -15.415780 }, 
			"MGS/C05.jpg": { lat: 28.104083130613827, lng: -15.416124543195322 },
			"MGS/C06.jpg": { lat: 28.102494737211124, lng: -15.416195783873665 },
			"MGS/C07.jpg": { lat: 28.1021455696441, lng: -15.4157773960626 },
			"MGS/C08.jpg": { lat: 28.101777568276407, lng: -15.415517835223058 },
			"MGS/C09.jpg": { lat: 28.100695792727716, lng: -15.415112765211047 },
			"MGS/C10.jpg": { lat: 28.10035367542168, lng: -15.415976713670425 },
			"MGS/C11.jpg": { lat: 28.09986242583599, lng: -15.416717015257847 },
			"MGS/C12.jpg": { lat: 28.10036399095969, lng: -15.415001888800532 },
			"MGS/C13.jpg": { lat: 28.101312220228376, lng: -15.414699608455459 },
			"MGS/C14.jpg": { lat: 28.103155016825813, lng: -15.413515359336174 },
			"MGS/C15.jpg": { lat: 28.103059353051304, lng: -15.413733853928663 },
			"MGS/M01.jpg": { lat: 28.09994446913674, lng: -15.415180608216648 },
		};
		
		function addMarkersToMap(locations, map) {
			Object.entries(locations).forEach(([image, { lat, lng }]) => {
				L.marker([lat, lng])
					.addTo(map)
					.bindPopup(`<img src="${image}" width="100px"><br>${image.split("/").pop()}`)
					.on("click", () => {
						document.getElementById("imageSelect").value = image;
						updateOverlay(image);
					});
			});
		}

		addMarkersToMap(imageLocations, map);
		
		imageSelect.addEventListener("change", event => {
			const selectedImage = event.target.value;
			updateOverlay(selectedImage);
    
		if (imageLocations[selectedImage]) {
			const { lat, lng } = imageLocations[selectedImage];
			map.setView([lat, lng], 15); // Acerca el mapa a la imagen seleccionada
		}
		});
		
		const clickSound = new Audio("MGS/VL.mp3");
				
		Object.keys(imageLocations).forEach(image => {
			const { lat, lng } = imageLocations[image];
			const marker = L.marker([lat, lng]).addTo(map)
				.bindPopup(`<img src="${image}" width="100px"><br>${image.split("/").pop()}`)
				.on("click", () => {
					imageSelect.value = image;  // Seleccionar imagen en el dropdown
					changeOverlayImage(image);  // Usar la nueva función corregida
					clickSound.play();          // Reproducir sonido
				});
		});
		
		clickSound.currentTime = 0;
		clickSound.play();
		
		document.addEventListener("DOMContentLoaded", function() {
			const museumMapContainer = document.getElementById("museumMapContainer");
			const openMuseumMapButton = document.getElementById("openMuseumMap");
			const closeMuseumMapButton = document.getElementById("closeMuseumMap");

			// Evento para abrir el mapa del museo
			openMuseumMapButton.addEventListener("click", function() {
				museumMapContainer.classList.toggle("active"); // Muestra el mapa del museo
					setTimeout(() => {
						museumMap.invalidateSize(); // Ajusta el mapa de Leaflet después de la animación
					}, 300); // Esperar 300ms para que la animación del panel termine
				});

			// Evento para cerrar el mapa del museo
			closeMuseumMapButton.addEventListener("click", function() {
				museumMapContainer.classList.remove("active"); // Oculta el mapa del museo
			});
		});

		const museumMap = L.map('museumMap', {
			crs: L.CRS.Simple,
			minZoom: -2,
			maxZoom: 2
		});

		const bounds = [[0, 0], [1000, 1000]]; // Ajustar según imagen
		const museumImage = L.imageOverlay('MGS/Plan01.jpg', [[0, 0], [1000, 1000]]).addTo(museumMap);
		
		museumMap.on('click', function (e) {
			alert(`Coordenadas: ${e.latlng.lat}, ${e.latlng.lng}`);
		});

		museumMap.fitBounds(bounds);

		// Marcadores del museo
		const museumMarkers = [
			{ coords: [411.75, 630], title: "Tienda", img: "MGS/M02.jpg" },
			{ coords: [869, 587.25], title: "Cerámica aborigen de Gran Canaria", img: "MGS/M03.jpg" },
			{ coords: [784.5, 466.5], title: "Manufacturas en pieles y fibras vegetales", img: "MGS/M04.jpg" },
			{ coords: [472.25, 634.25], title: "Poblados", img: "MGS/M05.jpg" },
			{ coords: [780.5, 706.75], title: "Bioantropología", img: "MGS/M06.jpg" },
			{ coords: [845.5, 342], title: "Exposiciones temporales", img: "MGS/M07.jpg" },
			{ coords: [495.5, 571], title: "Poblados", img: "MGS/M10.jpg" },
			{ coords: [831.75, 707.5], title: "Tecnología cerámica", img: "MGS/M11.jpg" },
			{ coords: [768.5, 631.5], title: "Espacios Funerarios", img: "MGS/M12.jpg" },
			{ coords: [702, 378], title: "Salón de actos", img: "MGS/M14.jpg" }
		];
		
		museumMarkers.forEach(({ coords, title, img }) => {
			L.marker(coords).addTo(museumMap)
				.bindPopup(`<b>${title}</b><br><img src='${img}' width='150'>`)
				.on("click", function() {
					let overlay = document.getElementById("overlay");
					if (overlay) {
						imageSelect.value = img;
						changeOverlayImage(img); // Usar la nueva función corregida
					}
					clickSound.currentTime = 0;
					clickSound.play().catch(error => console.error("Error al reproducir el sonido:", error));
				});
		});
		
		function openPopup(title, imgSrc, description) {
			document.getElementById("popupTitle").textContent = title;
			document.getElementById("popupImage").src = imgSrc;
			document.getElementById("popupDescription").textContent = description;
			document.getElementById("imagePopup").style.display = "flex";
		}

		function closePopup() {
			document.getElementById("imagePopup").style.display = "none";
		}

		// Asociar información a cada imagen
		const imageInfo = {
			"MGS/C01.jpg": { 
			title: "Las Palmas. Parque Cervantes.", 
			description: "Vista parcial del parque de San Telmo, entonces denominado parque de Cervantes. Aparece uno de sus quioscos, concretamente el situado en el lado noroeste, de estilo modernista y proyectadoen 1923 por Rafael Masanet y Faus." 
			},
			"MGS/C02.jpg": { 
			title: "Las Palmas. Calle de León y Castillo.", 
			description: "Tarjeta postal mostrando un plano general de la cabeza de un desfile militar llegando al comienzo de la calle León y Castillo, pasando entre el Gobierno Militar de Las Palmas y el parque de San Telmo." 
			},
			"MGS/C03.jpg": { 
			title: "Calle Triana, esquina con la calle Arena", 
			description: "Plano general del edificio que se encuentra en la esquina que entrecruzan las calles de Triana y Arena. Son visibles los distintos comercios que se encuentran en la planta baja del citado edificio (entre ellos una farmacia, una relojería y un local llamado La Madrileña)." 
			},
			"MGS/C04.jpg": { 
			title: "Calle Triana en la esquina con la calle Torres.", 
			description: "Vista parcial de la calle Mayor de Triana tomada desde la esquina con la calle Torres. En la imagen destaca el trasiego de tartanas y carretas de tracción animal sobre la vía adoquinada, así como un hombre en primer plano con un animal de carga." 
			},
			"MGS/C05.jpg": { 
			title: "Casa natal de Benito Pérez Galdós.", 
			description: "Vista lateral de la fachada de la casa natal de Benito Pérez Galdós situada en la calle Cano, número 2 (Galdós vivió hasta los 19 años en esta vivienda familiar ubicada en el barrio de Triana)." 
			},
			"MGS/C06.jpg": { 
			title: "Calle Muro, carruajes y catedral.", 
			description: "Vista parcial de la calle Muro en el casco histórico de Triana. En el centro de la imagen y parcialmente oculto por los carruajes de la calle, se distingue el puente de Verdugo o puente de Piedra, que cruzaba el barranco Guiniguada y unía los barrios de Triana y Vegueta." 
			},
			"MGS/C07.jpg": { 
			title: "Pabellón de Agricultura e Industria en la plaza de Hurtado de Mendoza.", 
			description: "Vista general del pabellón de Agricultura e Industria en la plaza de Hurtado de Mendoza durante la celebración de la Fiesta de las Flores en abril de 1892." 
			},
			"MGS/C08.jpg": { 
			title: "Las Palmas, puente de Verdugo.", 
			description: "Vista parcial del puente Verdugo ('puente de piedra'). Se identifican dos de las cuatro estatuas que se erigen en sus cuatro esquinas y llamadas las cuatro estaciones. En segundo plano se observa el pequeño cauce del barranco Guiniguada." 
			},
			"MGS/C09.jpg": { 
			title: "Las Palmas. Plaza de Santa Ana.", 
			description: "Plano general de la Plaza de Santa Ana con el edificio del Ayuntamiento en el fondo de la imagen y las construcciones que la bordean. Numerosas personas miran hacia la cámara desde la plaza donde destaca el mobiliario y equipamiento urbano de la misma." 
			},
			"MGS/C10.jpg": { 
			title: "Catedral de Las Palmas.", 
			description: "Vista general de la fachada de la catedral de Las Palmas y de la plaza de Santa Ana." 
			},
			"MGS/C11.jpg": { 
			title: "Plaza del Espíritu Santo.", 
			description: "Vista general de la plaza del Espíritu Santo, en el casco histórico de Vegueta. En el centro de la imagen se ve la citada plazoleta, con parterres en los que destacan las altas palmeras canarias y el drago." 
			},
			"MGS/C12.jpg": { 
			title: "Cortejo fúnebre pasando delante de la catedral de Santa Ana.", 
			description: "Vista parcial de un cortejo fúnebre pasando delante de la catedral de Canarias, en el barrio histórico de Vegueta. Podría tatarse del cortejo fúnebre del poeta Tomás Morales." 
			},
			"MGS/C13.jpg": {
			title: "Vegueta, plazoleta de Los Álamos.", 
			description: "Vista parcial de la plazoleta de Los Álamos, ubicada en un lateral de la fachada posterior de la catedral de Las Palmas en el barrio de Vegueta." 
			},
			"MGS/C14.jpg": { 
			title: "Teatro Pérez Galdós y Barranco Guiniguada.", 
			description: "Vista general de la fachada del teatro Pérez Galdós ubicado en la zona sur del barrio histórico de Triana. En primer plano se ve parcialmente el cauce del barranco Guiniguada. En segundo plano se puede observar la fachada de estilo neoclásico y un lateral del teatro." 
			},
			"MGS/C15.jpg": { 
			title: "Barranco Guiniguada y Puente de Palo.", 
			description: "Vista parcial del cauce del barranco Guiniguada cerca de su desembocadura. En el centro de la imagen se ve el antiguo puente de López Botas, llamado popularmente Puente de Palo, que unía los barrios históricos de Vegueta y Triana a la altura del mercado. Sobre él se aprecian dos de los cuatro kioscos que flanqueaban sus extremos." 
			},
			"MGS/M01.jpg": { title: "Fachada de El Museo Canario", 
			description: "Vista general de la fachada de El Museo Canario." 
			},
			"MGS/M02.jpg": {title: "Biblioteca de El Museo Canario.",
			description: "Vista parcial de la biblioteca de El Museo Canario."
			},
			"MGS/M03.jpg": {title: "Antiguas salas de cerámicas aborígenes, El Museo Canario",
			description: "Vista parcial de la que actualmente se conoce como Sala 10 'La cerámica aborigen de Gran Canaria' de El Museo Canario."
			},
			"MGS/M04.jpg": {title: "Antigua sala de minerales (Sección de Petrografía), El Museo Canario",
			description: "Vista parcial de la antigua sala dedicada a minerales de El Museo Canario (denominada Sección de Petrografía en la época)."
			},
			"MGS/M05.jpg": {title: "Antigua sala de Malacología e Ictiología (Sala Ripoche), El Museo Canario",
			description: "Vista parcial de la antigua sala de Malacología e Ictiología de El Museo Canario, llamada 'Sala Ripoche' (actualmente ocupa el mismo espacio la Sala 1 'El hábitat'). Destaca el material perteneciente a la colección de Ciencias Naturales. En primer plano se aprecia un pez manta."
			},
			"MGS/M06.jpg": {title: "Sala de 'La antropología física' (Sala 7), El Museo Canario",
			description: "Vista parcial de la sala identificada como 'La antropología física' de El Museo Canario, dedicada al doctor René Verneau. Destacan los cráneos y demás restos óseos humanos en sus vitrinas, los bustos de diferentes razas sobre las mismas y los restos momificados alojados en las vitrinas centrales."
			},
			"MGS/M07.jpg": {title: "El Museo Canario, sala de Historia Natural",
			description: "Vista parcial de la antigua sala dedicada a la colección de vertebrados. La sala se halla rodeada de vitrinas donde, como se observa, se alojan los animales disecados y sobre las mismas se encuentra una colección de cráneos. Del techo cuelga un ave con las alas extendidas."
			},
			"MGS/M08.jpg": {title: "",
			description: ""
			},
			"MGS/M09.jpg": {title: "",
			description: ""
			},
			"MGS/M10.jpg": {title: "Antigua sala de Malacología e Ictiología (Sala Ripoche), El Museo Canario",
			description: "Vista parcial de la antigua sala de Malacología e Ictiología de El Museo Canario (actualmente sala 1, 'El hábitat'), dedicada al Doctor Chil y Naranjo. Destaca el material perteneciente a la colección de Ciencias Naturales."
			},
			"MGS/M11.jpg": {title: "Salas de tecnología lítica, morteros, molinos y cerámicas de El Museo Canario",
			description: "Vista parcial de las actuales salas 9 'La tecnología cerámica' y 10 'La cerámica aborigen de Gran Canaria' de El Museo Canario, antiguamente empleadas para exponer tecnología lítica, morteros, molinos y cerámicas."
			},
			"MGS/M12.jpg": {title: "Grupo de visitantes en las salas de exposiciones de El Museo Canario",
			description: "Retrato de conjunto realizado a un grupo de visitantes posando para la cámara en la actualmente identificada como sala de 'La antropología física' (Sala 7) de El Museo Canario, dedicada al doctor René Verneau."
			},
			"MGS/M14.jpg": {title: "Homenaje a Saulo Torón en El Museo Canario",
			description: "Vista general del público asistente al homenaje a Saulo Torón organizado y realizado por El Museo Canario en su salón de actos. Se identifican sentados en primera fila, empezando por la izquierda, a: Vicente Doreste Medina, teniente de alcalde adjunto a la presidencia (segundo); Ervigio Díaz Bertrana, consejero de Cultura del Cabildo (tercero); Enrique Blanco Torrent, concejal delegado de cultura del Ayuntamiento de Las Palmas (cuarto); Pedro Cullen del Castillo (quinto); Lorenzo Olarte Cullen, presidente del Cabildo Insular de Gran Canaria (sexto); Juan Nogales Hernández, director de El Museo Canario (séptimo); Saulo Torón Macario (octavo) y María Isabel Torón Macario (novena)."
			},
		};

		// Agregar botones de información en las imágenes
		document.addEventListener("DOMContentLoaded", function () {
			const openInfoButton = document.getElementById("openInfoButton");
			const overlay = document.getElementById("overlay");

		openInfoButton.addEventListener("click", function () {
			let selectedImage = overlay.src;

        // Asegurar que se obtiene solo el nombre del archivo
        try {
            selectedImage = "MGS/" + new URL(selectedImage, window.location.href).pathname.split('/').pop();
        } catch (error) {
            console.error("Error al obtener el nombre del archivo:", error);
        }

        // Buscar la información en imageInfo
        if (imageInfo.hasOwnProperty(selectedImage)) {
            const imageData = imageInfo[selectedImage];
            openPopup(imageData.title, overlay.src, imageData.description);
        } else {
            console.warn("No se encontró información para la imagen:", selectedImage);
            openPopup("Imagen Histórica", overlay.src, "No hay información disponible.");
				}
			});
		});
		
		// Función para obtener la ubicación del usuario
		
		let locationWatcherStarted = false;
		function watchUserLocation() {
			if (!locationWatcherStarted) {
				locationWatcherStarted = true;

				if ("geolocation" in navigator) {
					navigator.geolocation.watchPosition(
						position => {
							const userLat = position.coords.latitude;
							const userLng = position.coords.longitude;
							checkProximity(userLat, userLng);
						},
						error => console.error("Error al obtener la ubicación:", error),
						{
							enableHighAccuracy: true,
							maximumAge: 5000,
							timeout: 5000
						}
					);
				} else {
					console.error("Geolocalización no soportada en este navegador.");
				}
			}
		}

		// Función para calcular la distancia entre dos coordenadas en metros
		
		function calculateDistance(lat1, lng1, lat2, lng2) {
			const R = 6371e3; // Radio de la Tierra en metros
			const φ1 = lat1 * (Math.PI / 180);
			const φ2 = lat2 * (Math.PI / 180);
			const Δφ = (lat2 - lat1) * (Math.PI / 180);
			const Δλ = (lng2 - lng1) * (Math.PI / 180);

			const a =
				Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
				Math.cos(φ1) * Math.cos(φ2) * Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
			const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

			return R * c; // Distancia en metros
		}

		// Función para verificar si el usuario está cerca de un marcador
		
		function checkProximity(userLat, userLng) {
			const imageSelect = document.getElementById("imageSelect");
			const overlay = document.getElementById("overlay");

			if (!imageSelect || !overlay) {
				console.error("Elementos no encontrados: imageSelect o overlay.");
				return;
			}

			const proximityRadius = 20; // Radio en metros para activar la imagen

			Object.keys(imageLocations).forEach(image => {
				const { lat, lng } = imageLocations[image];
				const distance = calculateDistance(userLat, userLng, lat, lng);

				if (distance <= proximityRadius) {
					if (!visitedImages.includes(image)) {
						visitedImages.push(image);
						visitCount = visitedImages.length;
						localStorage.setItem("visitedImages", JSON.stringify(visitedImages));
						addXP(20);
						alert(`📍 Has descubierto un nuevo lugar: ${image.split("/").pop()} (${visitCount} en total)`);
					}

					if (!overlay.src.includes(image)) {
						imageSelect.value = image;
						updateOverlay(image);

						if ("vibrate" in navigator) navigator.vibrate(200);
					}
				}
			});
		}

		window.addEventListener("load", function() {
			// **Iniciar la detección de ubicación**
			watchUserLocation();
		});

		document.addEventListener("DOMContentLoaded", function() {
			const settingsButton = document.getElementById("settingsButton");
			if (!settingsButton) {
				console.error("Error: No se encontró el botón de configuración.");
				return;
			}
			let cameraActive = true;
			let locationActive = true;

		settingsButton.addEventListener("click", function() {
			const cameraElement = document.getElementById("camera");

        // Alternar la cámara
        if (cameraActive) {
            let stream = cameraElement.srcObject;
            if (stream) {
                let tracks = stream.getTracks();
                tracks.forEach(track => track.stop()); // Detener la cámara
            }
            cameraElement.srcObject = null;
            console.log("Cámara desactivada");
        } else {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(stream => {
                    cameraElement.srcObject = stream;
                    console.log("Cámara activada");
                })
                .catch(err => console.error("Error al acceder a la cámara:", err));
        }
        cameraActive = !cameraActive;

        // Alternar la detección de ubicación
        if (locationActive) {
            console.log("Ubicación desactivada");
            locationActive = false;
        } else {
            watchUserLocation();
            console.log("Ubicación activada");
            locationActive = true;
        }
			});
		});
		
		document.addEventListener("DOMContentLoaded", function() {
		document.getElementById("resetOverlay").addEventListener("click", function() {
			updateOverlay(""); // limpia la imagen y muestra el placeholder
			document.getElementById("opacity").value = 0.5;
			overlay.style.opacity = 0.5;
			imageSelect.value = "";
			});
		});
		
		// Función sobre la captura de comparación
		
		document.addEventListener("DOMContentLoaded", function () {
			document.getElementById("captureButton").addEventListener("click", function () {
				const container = document.querySelector(".container"); // Capturar toda la vista de la cámara

				html2canvas(container, {
					useCORS: true, // Evita problemas con imágenes externas
					backgroundColor: null // Mantiene transparencia
				}).then(canvas => {
					canvas.toBlob(blob => {
						if (blob) {
							const link = document.createElement("a");
							link.href = URL.createObjectURL(blob);
							link.download = "comparacion_retroSpectare.png";
							link.click();
						} else {
							console.error("Error: No se pudo generar la imagen.");
						}
					});
				}).catch(error => console.error("Error al capturar la imagen:", error));
			});
		});
		
		function changeOverlayImage(imageSrc) {
			overlay.style.opacity = "0"; // Ocultar imagen actual suavemente

			setTimeout(() => {
				updateOverlay(imageSrc);
				overlay.style.opacity = "0.5"; // Restablece la opacidad
			}, 500);
		};
		
		let currentCamera = "environment"; // Iniciar con la cámara trasera
		let videoElement = document.getElementById("camera");

		async function startCamera(cameraFacing) {
			try {
				// Detener la transmisión actual si existe
				if (videoElement.srcObject) {
					let tracks = videoElement.srcObject.getTracks();
					tracks.forEach(track => track.stop());
				}

				// Intentar acceder a la cámara con más control sobre la resolución
				let stream = await navigator.mediaDevices.getUserMedia({
					video: { 
						facingMode: cameraFacing,
						width: { ideal: 1280 }, 
						height: { ideal: 720 } 
					}
				});

				videoElement.srcObject = stream;
			} catch (err) {
				console.error("Error al acceder a la cámara:", err);
				alert("No se pudo acceder a la cámara " + (cameraFacing === "user" ? "frontal" : "trasera"));
			}
		}

		// Alternar entre cámaras
		document.getElementById("toggleCamera").addEventListener("click", function() {
			currentCamera = (currentCamera === "environment") ? "user" : "environment";
			startCamera(currentCamera);
		});

		// Iniciar con la cámara trasera
		window.addEventListener("load", function() {
			startCamera(currentCamera);
		});
		
		const routes = {
			"Triana": {
				images: ["MGS/C03.jpg", "MGS/C04.jpg", "MGS/C05.jpg", "MGS/C14.jpg"],
				description: "Explora la histórica calle Triana y sus alrededores.",
				thumbnail: "MGS/C03.jpg"
			},
			"Vegueta": {
				images: ["MGS/C09.jpg", "MGS/C10.jpg", "MGS/C12.jpg", "MGS/C13.jpg", "MGS/C15.jpg"],
				description: "Recorre los sitios más emblemáticos del barrio de Vegueta.",
				thumbnail: "MGS/C10.jpg"
			},
			"Museo Canario": {
				images: ["MGS/M01.jpg", "MGS/M02.jpg", "MGS/M03.jpg", "MGS/M04.jpg", "MGS/M06.jpg"],
				description: "Descubre la historia en El Museo Canario.",
				thumbnail: "MGS/M01.jpg"
			},
			"Barranco Guiniguada": {
				images: ["MGS/C08.jpg", "MGS/C15.jpg", "MGS/C14.jpg"],
				description: "Sigue la ruta del Barranco Guiniguada y su legado histórico.",
				thumbnail: "MGS/C08.jpg"
			}
		};

		function loadRoutesMenu() {
			const routesList = document.getElementById("routesList");
			routesList.innerHTML = ""; // Limpiar el contenido previo

			Object.entries(routes).forEach(([routeName, routeData]) => {
				const routeItem = document.createElement("div");
				routeItem.classList.add("route-item");
				routeItem.innerHTML = `
					<img src="${routeData.thumbnail}" alt="${routeName}" class="route-thumbnail">
					<div>
						<h3>${routeName}</h3>
						<p>${routeData.description}</p>
						<button class="start-route-button" data-route="${routeName}">Iniciar Ruta</button>
					</div>
				`;
				routesList.appendChild(routeItem);
			});

			document.querySelectorAll(".start-route-button").forEach(button => {
				button.addEventListener("click", function () {
					startRoute(this.getAttribute("data-route"));
				});
			});
		}
		
		let currentRouteImages = [];
			let currentRouteIndex = 0;

			function startRoute(routeName) {
				if (!routes[routeName]) return;

				currentRouteImages = routes[routeName].images;
				currentRouteIndex = 0;

				showCurrentRouteImage();
			}

			function showCurrentRouteImage() {
				if (currentRouteIndex < currentRouteImages.length) {
					const imageSrc = currentRouteImages[currentRouteIndex];

					// Aplicar transición de salida
					overlay.style.opacity = "0";  // Desvanecer la imagen actual
					overlay.style.left = "60%";  // Mover la imagen ligeramente a la derecha

					setTimeout(() => {
						overlay.src = imageSrc;  // Cambiar la imagen
						overlay.style.left = "50%";  // Regresar la imagen al centro
						overlay.style.opacity = "0.5";  // Volver a mostrar la imagen
					}, 500);  // Esperar 500ms para completar la transición

					// Si la imagen tiene ubicación, mover el mapa
					if (imageLocations[imageSrc]) {
						const { lat, lng } = imageLocations[imageSrc];
						map.setView([lat, lng], 15);
					}

					currentRouteIndex++;
				} else {
					alert("¡Has completado la ruta!");
					currentRouteIndex = 0; // Reiniciar la ruta
				}
			}
			
		document.getElementById("nextRouteImageButton").addEventListener("click", showCurrentRouteImage);
		
		document.addEventListener("DOMContentLoaded", function () {
			const routesButton = document.getElementById("routesButton");
			const routesMenu = document.getElementById("routesMenu");
			const closeRoutesMenu = document.getElementById("closeRoutesMenu");

			if (!routesButton || !routesMenu || !closeRoutesMenu) {
				console.error("Error: No se encontraron los elementos del menú de rutas.");
				return;
			}

			// Función para alternar la visibilidad del menú de rutas
			function toggleRoutesMenu() {
				if (routesMenu.style.right === "0px") {
					routesMenu.style.right = "-390px"; // Ocultar menú
				} else {
					routesMenu.style.right = "0px"; // Mostrar menú
					loadRoutesMenu(); // Cargar las rutas en el menú
				}
			}

			// Agregar evento de clic al botón de rutas
			routesButton.addEventListener("click", toggleRoutesMenu);

			// Agregar evento de clic para cerrar el menú
			closeRoutesMenu.addEventListener("click", function () {
				routesMenu.style.right = "-390px"; // Ocultar menú
			});
		});
		
		document.getElementById("year").textContent = new Date().getFullYear();
		
		// Ficha del usuario
		
		let visitedImages = JSON.parse(localStorage.getItem("visitedImages") || "[]");
		let visitCount = visitedImages.length;

		let userXP = parseInt(localStorage.getItem("userXP") || "0");
		let userLevel = parseInt(localStorage.getItem("userLevel") || "1");

		function updateProfileUI() {
			document.getElementById("profileVisitCount").textContent = visitCount;
			document.getElementById("userLevel").textContent = userLevel;
			document.getElementById("currentXP").textContent = userXP;
			const xpToNext = userLevel * 100;
			document.getElementById("xpToNext").textContent = xpToNext;
			document.getElementById("xpBar").style.width = `${(userXP / xpToNext) * 100}%`;
		}

		function addXP(amount) {
			userXP += amount;
			const xpToNext = userLevel * 100;
			if (userXP >= xpToNext) {
				userXP -= xpToNext;
				userLevel++;
				alert(`🎉 ¡Subiste a nivel ${userLevel}!`);
			}
			localStorage.setItem("userXP", userXP);
			localStorage.setItem("userLevel", userLevel);
			updateProfileUI();
		}
		
		// Sistema de insignias
		
		function checkBadges() {
		const badgeContainer = document.getElementById("badgeContainer");
		badgeContainer.innerHTML = "";

		const badges = [
			{ id: "badge1", name: "Explorador Novato", condition: visitCount >= 5, emoji: "🥉" },
			{ id: "badge2", name: "Aventurero Local", condition: visitCount >= 10, emoji: "🥈" },
			{ id: "badge3", name: "Maestro del Pasado", condition: visitCount >= 20, emoji: "🏆" },
			{ id: "badge4", name: "Rutero", condition: userLevel >= 2, emoji: "🗺️" },
		];

		badges.forEach(b => {
			const unlocked = b.condition;
			const badge = document.createElement("div");
			badge.textContent = unlocked ? `${b.emoji} ${b.name}` : "🔒 ???";
			badge.style.background = unlocked ? "#e3f2fd" : "#eee";
			badge.style.padding = "6px 10px";
			badge.style.borderRadius = "6px";
			badge.style.fontSize = "14px";
			badgeContainer.appendChild(badge);
		});
	}
		// Botón para abrir/cerra el perfil
		
		document.addEventListener("DOMContentLoaded", () => {
			const openBtn = document.getElementById("openProfileButton");
			const closeBtn = document.getElementById("closeProfileButton");
			const panel = document.getElementById("userProfile");

			openBtn.addEventListener("click", () => {
				panel.style.right = panel.style.right === "0px" ? "-390px" : "0px";
				updateProfileUI();
				checkBadges();
			});

			closeBtn.addEventListener("click", () => {
				panel.style.right = "-390px";
			});

			updateProfileUI();
			checkBadges();
		});
		
		const placeholder = document.getElementById("overlayPlaceholder");

		function updateOverlay(src) {
			overlay.src = src;

			// Comprobar si la ruta está vacía para mostrar el placeholder
			setTimeout(() => {
				if (!src || src.trim() === "") {
					placeholder.style.display = "block";
				} else {
					placeholder.style.display = "none";
				}
			}, 50);
		}		

		const fullscreenButton = document.getElementById("fullscreenButton");
		const icon = fullscreenButton.querySelector("i");
		const container = document.querySelector(".container");
		
		function enterFullscreen() {
		const elem = document.querySelector(".container");

		  if (elem.requestFullscreen) {
			return elem.requestFullscreen();
		  } else if (elem.webkitRequestFullscreen) {
			return elem.webkitRequestFullscreen(); // Safari
		  } else if (elem.msRequestFullscreen) {
			return elem.msRequestFullscreen(); // IE/Edge
		  } else {
			return Promise.reject("Fullscreen no soportado");
		  }
		}

		function exitFullscreen() {
		  if (document.exitFullscreen) {
			return document.exitFullscreen();
		  } else if (document.webkitExitFullscreen) {
			return document.webkitExitFullscreen();
		  } else if (document.msExitFullscreen) {
			return document.msExitFullscreen();
		  } else {
			return Promise.reject("Salir de fullscreen no soportado");
		  }
		}

		fullscreenButton.addEventListener("click", () => {
		  if (!document.fullscreenElement && !document.webkitFullscreenElement) {
			enterFullscreen().then(() => {
			  document.body.classList.add("fullscreen-active");
			  icon.classList.replace("fa-expand", "fa-compress");
			}).catch(err => {
			  console.warn("Error al entrar en pantalla completa:", err);
			});
		  } else {
			exitFullscreen().then(() => {
			  document.body.classList.remove("fullscreen-active");
			  icon.classList.replace("fa-compress", "fa-expand");
			});
		  }
		});

    </script>
</body>
</html>
